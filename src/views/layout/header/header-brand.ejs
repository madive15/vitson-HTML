<% const _src = srcPath; const _public = publicPath; %>

<%
const rawBrands = require(_src + '/views/mock-data/common/brand.mock.json');
const allBrands = rawBrands.map(item => item.brandNm.trim()).filter(name => name);

function getChosung(char) {
  const code = char.charCodeAt(0) - 0xAC00;
  if (code < 0 || code > 11171) return null;
  const list = ['ㄱ','ㄲ','ㄴ','ㄷ','ㄸ','ㄹ','ㅁ','ㅂ','ㅃ','ㅅ','ㅆ','ㅇ','ㅈ','ㅉ','ㅊ','ㅋ','ㅌ','ㅍ','ㅎ'];
  return list[Math.floor(code / 588)];
}

function normalizeChosung(cho) {
  const map = { 'ㄲ': 'ㄱ', 'ㄸ': 'ㄷ', 'ㅃ': 'ㅂ', 'ㅆ': 'ㅅ', 'ㅉ': 'ㅈ' };
  return map[cho] || cho;
}

const krChars = ['ㄱ','ㄴ','ㄷ','ㄹ','ㅁ','ㅂ','ㅅ','ㅇ','ㅈ','ㅊ','ㅋ','ㅌ','ㅍ','ㅎ'];
const enChars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ'.split('');

const korean = {};
const alphabet = {};
krChars.forEach(c => korean[c] = []);
enChars.forEach(c => alphabet[c] = []);

allBrands.forEach(name => {
  for (let i = 0; i < name.length; i++) {
    const char = name.charAt(i);

    if (/[가-힣]/.test(char)) {
      const cho = normalizeChosung(getChosung(char));
      if (cho && korean[cho]) korean[cho].push(name);
      break;
    }

    if (/[A-Za-z]/.test(char)) {
      const upper = char.toUpperCase();
      if (alphabet[upper]) alphabet[upper].push(name);
      break;
    }
  }
});

Object.keys(korean).forEach(k => korean[k].sort());
Object.keys(alphabet).forEach(k => alphabet[k].sort());
%>

<div class="gnb-left-item">
  <button
    type="button"
    class="gnb-btn brand"
    data-toggle-btn
    data-toggle-target="gnb-brand"
    data-toggle-outside="true"
    aria-expanded="false"
  >
    <span class="icon left"><%- include(`${_src}/views/components/icon.ejs`, { iconName: 'label' }) %></span>
    <span class="text">브랜드</span>
    <span class="icon right"><%- include(`${_src}/views/components/icon.ejs`, { iconName: 'arrow-down' }) %></span>
  </button>

  <div class="gnb-panel gnb-panel-brand" data-toggle-box="gnb-brand">
    <h2 class="sr-only">전체브랜드</h2>
    <div class="vits-inner">

      <%# 브랜드 검색 %>
      <div class="gnb-panel-head">
        <!-- prettier-ignore -->
        <%- include(`${_src}/views/components/form/input-search.ejs`, {
          idPrefix: 'bnSearch',
          action: '/brand/search',
          name: 'bnSearch',
          placeholder: '브랜드명을 검색하세요',
          formClass: 'vits-brand-search-form',
          addDataInput: 'brand-search-input',
          addBtnText: '검색하기',
          hasClear: true
        }) %>
      </div>

      <%# 브랜드 리스트 %>
      <div class="gnb-panel-body">
        <div class="vits-brand-tab" data-brand-tab data-default-tab="korean">

          <%# 탭 네비게이션 %>
          <div class="tab-nav" role="tablist" aria-label="브랜드 정렬">
            <button type="button" role="tab" class="tab-btn is-all"
                    id="brand-tab-all"
                    data-tab-trigger="all"
                    aria-selected="false"
                    aria-controls="brand-panel-all"
                    tabindex="-1">전체</button>

            <%# 가나다순 (디폴트) %>
            <div class="tab-group is-open" data-tab-group="korean">
              <button type="button" role="tab" class="tab-btn is-active"
                      id="brand-tab-korean"
                      data-tab-trigger="korean"
                      aria-selected="true"
                      aria-controls="brand-panel-korean">가나다순</button>
              <div class="tab-sub-nav" role="tablist" aria-label="가나다순 필터">
                <% krChars.forEach((c, i) => { %>
                <button type="button" role="tab"
                        class="tab-sub-btn<%= i === 0 ? ' is-active' : '' %>"
                        data-sub-trigger="<%= c %>"
                        aria-selected="<%= i === 0 %>"
                        <%= i !== 0 ? 'tabindex="-1"' : '' %>><%= c %></button>
                <% }); %>
              </div>
            </div>

            <%# 알파벳순 %>
            <div class="tab-group" data-tab-group="alphabet">
              <button type="button" role="tab" class="tab-btn"
                      id="brand-tab-alphabet"
                      data-tab-trigger="alphabet"
                      aria-selected="false"
                      aria-controls="brand-panel-alphabet"
                      tabindex="-1">알파벳순</button>
              <div class="tab-sub-nav" role="tablist" aria-label="알파벳순 필터">
                <% enChars.forEach((c, i) => { %>
                <button type="button" role="tab"
                        class="tab-sub-btn<%= i === 0 ? ' is-active' : '' %>"
                        data-sub-trigger="<%= c %>"
                        aria-selected="<%= i === 0 %>"
                        <%= i !== 0 ? 'tabindex="-1"' : '' %>><%= c %></button>
                <% }); %>
              </div>
            </div>
          </div>

          <%# 탭 패널 %>
          <div class="tab-panels">
            <div class="tab-panels-inner">

              <%# 전체 %>
              <div class="tab-panel" id="brand-panel-all" role="tabpanel" aria-labelledby="brand-tab-all" data-tab-panel="all" hidden>
                <p class="result-count"><strong data-brand-count><%= allBrands.length %></strong>개의 브랜드</p>
                <div class="result-list">
                  <% allBrands.forEach(name => { %>
                  <a class="vits-gnb-promo-button" href="#!" data-brand-item><span class="text"><%= name %></span></a>
                  <% }); %>
                </div>
              </div>

              <%# 가나다순 %>
              <div class="tab-panel is-active" id="brand-panel-korean" role="tabpanel" aria-labelledby="brand-tab-korean" data-tab-panel="korean">
                <% krChars.forEach((c, i) => { %>
                <div class="tab-sub-panel<%= i === 0 ? ' is-active' : '' %>" data-sub-panel="<%= c %>"<%= i !== 0 ? ' hidden' : '' %>>
                  <p class="result-count"><strong data-brand-count><%= korean[c].length %></strong>개의 브랜드</p>
                  <div class="result-list">
                    <% korean[c].forEach(name => { %>
                    <a class="vits-gnb-promo-button" href="#!" data-brand-item><span class="text"><%= name %></span></a>
                    <% }); %>
                  </div>
                </div>
                <% }); %>
              </div>

              <%# 알파벳순 %>
              <div class="tab-panel" id="brand-panel-alphabet" role="tabpanel" aria-labelledby="brand-tab-alphabet" data-tab-panel="alphabet" hidden>
                <% enChars.forEach((c, i) => { %>
                <div class="tab-sub-panel<%= i === 0 ? ' is-active' : '' %>" data-sub-panel="<%= c %>"<%= i !== 0 ? ' hidden' : '' %>>
                  <p class="result-count"><strong data-brand-count><%= alphabet[c].length %></strong>개의 브랜드</p>
                  <div class="result-list">
                    <% alphabet[c].forEach(name => { %>
                    <a class="vits-gnb-promo-button" href="#!" data-brand-item><span class="text"><%= name %></span></a>
                    <% }); %>
                  </div>
                </div>
                <% }); %>
              </div>

              <%# 검색결과 없음 %>
              <div class="tab-panel" id="brand-panel-empty" role="tabpanel" aria-label="검색결과 없음" data-tab-panel="empty" hidden>
                <div class="result-empty">
                  <p>검색결과가 없습니다.</p>
                </div>
              </div>

            </div>
          </div>
        </div>
      </div>

    </div>
  </div>
</div>