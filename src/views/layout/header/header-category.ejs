<% const _src = srcPath; const _public = publicPath; %>
<!-- prettier-ignore -->
<%
  var _md =
    (typeof mockData !== 'undefined' && mockData)
      ? mockData
      : ((typeof globalThis !== 'undefined' && globalThis.__mockData) ? globalThis.__mockData : {});

  var _path = (_md && _md.category && _md.category.path) ? _md.category.path : {};

  var d1Id = (typeof depth1Id !== 'undefined' && depth1Id) ? depth1Id : (_path.depth1Id || '');
  var d2Id = (typeof depth2Id !== 'undefined' && depth2Id) ? depth2Id : (_path.depth2Id || '');
  var d3Id = (typeof depth3Id !== 'undefined' && depth3Id) ? depth3Id : (_path.depth3Id || '');

  var tree = (_md && _md.category && Array.isArray(_md.category.tree)) ? _md.category.tree : [];

  function getCode(n) {
    return (n && n.categoryCode) ? String(n.categoryCode) : '';
  }

  function getName(n) {
    return (n && n.categoryNm) ? String(n.categoryNm) : '';
  }

  function getChildren(n) {
    return (n && Array.isArray(n.categoryList)) ? n.categoryList : [];
  }

  function getHrefByCode(code) {
    // NOTE: 운영 라우팅 확정 전까지는 코드 기반 임시 링크(필요 시 규칙 교체)
    return code ? ('/category/' + code) : '#';
  }

  // null code/name 노드 제거
  function normalize(list) {
    if (!Array.isArray(list)) return [];
    return list.filter(function (n) { return !!getCode(n) && !!getName(n); });
  }

  var lv1 = normalize(tree);

  if (!d1Id && lv1.length) d1Id = getCode(lv1[0]);

  var activeLv1 = lv1.filter(function (n) { return getCode(n) === d1Id; })[0] || null;
  var lv2OfActive = activeLv1 ? normalize(getChildren(activeLv1)) : [];
  if (!d2Id && lv2OfActive.length) d2Id = getCode(lv2OfActive[0]);

  var activeLv2 = lv2OfActive.filter(function (n) { return getCode(n) === d2Id; })[0] || null;
  var lv3OfActive = activeLv2 ? normalize(getChildren(activeLv2)) : [];
  if (!d3Id && lv3OfActive.length) d3Id = getCode(lv3OfActive[0]);
%>

<div class="gnb-left-item">
  <button
    type="button"
    class="gnb-btn category"
    data-toggle-btn
    data-toggle-target="gnb-category"
    aria-expanded="false"
  >
    <span class="icon left"> <%- include(`${_src}/views/components/icon.ejs`, { iconName: 'menu' }) %> </span>
    <span class="text">전체카테고리</span>
    <span class="icon right"> <%- include(`${_src}/views/components/icon.ejs`, { iconName: 'arrow-down' }) %> </span>
  </button>

  <div class="gnb-panel gnb-panel-category" data-toggle-box="gnb-category">
    <h2 class="sr-only">전체카테고리</h2>
    <div class="vits-inner">
      <div class="gnb-panel-body">
        <div class="gnb-category" data-gnb-category>
          <!-- 1뎁스 -->
          <div class="gnb-category-col gnb-category-col-1">
            <ul class="gnb-category-list gnb-category-list-1" data-gnb-d1>
              <!-- prettier-ignore -->
              <% lv1.forEach(function (d1) { 
                   var _d1 = getCode(d1);
                   var _d1LabelId = 'gnb-cat-d1-' + _d1 + '-label';
                   var _isD1Active = (_d1 && _d1 === d1Id);
              %>
              <li class="gnb-category-item <%= _isD1Active ? 'is-active' : '' %>" data-d1="<%- _d1 %>">
                <!-- prettier-ignore -->
                <a
                    id="<%- _d1LabelId %>"
                    href="<%- getHrefByCode(_d1) %>"
                    class="gnb-category-link"
                    aria-controls="gnb-cat-d2-<%- _d1 %>"
                    aria-expanded="<%= _isD1Active ? 'true' : 'false' %>"
                  >
                    <%- getName(d1) %>
                  </a>
              </li>
              <% }); %>
            </ul>
          </div>

          <!-- 2뎁스(영역 고정) -->
          <div class="gnb-category-col gnb-category-col-2" data-gnb-d2-col>
            <!-- prettier-ignore -->
            <% lv1.forEach(function (d1) {
                 var _d1 = getCode(d1);
                 var _d1LabelId = 'gnb-cat-d1-' + _d1 + '-label';
                 var _lv2 = normalize(getChildren(d1));
                 var _isD2BoxActive = (_d1 && _d1 === d1Id);
            %>
            <!-- prettier-ignore -->
            <div
                class="gnb-category-box <%= _isD2BoxActive ? 'is-active' : '' %>"
                id="gnb-cat-d2-<%- _d1 %>"
                data-d2-box="<%- _d1 %>"
                aria-labelledby="<%- _d1LabelId %>"
                aria-hidden="<%= _isD2BoxActive ? 'false' : 'true' %>"
              >
                <ul class="gnb-category-list gnb-category-list-2" data-gnb-d2>
                  <!-- prettier-ignore -->
                  <% _lv2.forEach(function (d2) {
                       var _d2 = getCode(d2);
                       var _d2LabelId = 'gnb-cat-d2-' + _d2 + '-label';
                       var _isD2Active = (_isD2BoxActive && _d2 && _d2 === d2Id);
                  %>
                    <li class="gnb-category-item <%= _isD2Active ? 'is-active' : '' %>" data-d2="<%- _d2 %>">
                      <!-- prettier-ignore -->
                      <a
                        id="<%- _d2LabelId %>"
                        href="<%- getHrefByCode(_d2) %>"
                        class="gnb-category-link"
                        aria-controls="gnb-cat-d3-<%- _d2 %>"
                        aria-expanded="<%= _isD2Active ? 'true' : 'false' %>"
                        tabindex="<%= _isD2BoxActive ? '0' : '-1' %>"
                      >
                        <%- getName(d2) %>
                      </a>
                    </li>
                  <% }); %>
                </ul>
              </div>
            <% }); %>
          </div>

          <!-- 3뎁스(영역 고정) -->
          <div class="gnb-category-col gnb-category-col-3" data-gnb-d3-col>
            <!-- prettier-ignore -->
            <% lv1.forEach(function (d1) {
                 var _lv2 = normalize(getChildren(d1));

                 _lv2.forEach(function (d2) {
                   var _d2 = getCode(d2);
                   var _d2LabelId = 'gnb-cat-d2-' + _d2 + '-label';
                   var _lv3 = normalize(getChildren(d2));
                   var _isD3BoxActive = (_d2 && _d2 === d2Id);
            %>
            <!-- prettier-ignore -->
            <div
                class="gnb-category-box <%= _isD3BoxActive ? 'is-active' : '' %>"
                id="gnb-cat-d3-<%- _d2 %>"
                data-d3-box="<%- _d2 %>"
                aria-labelledby="<%- _d2LabelId %>"
                aria-hidden="<%= _isD3BoxActive ? 'false' : 'true' %>"
              >
                <ul class="gnb-category-list gnb-category-list-3">
                  <!-- prettier-ignore -->
                  <% _lv3.forEach(function (d3) {
                       var _d3 = getCode(d3);
                       var _isD3Active = (_isD3BoxActive && _d3 && _d3 === d3Id);
                  %>
                    <li class="gnb-category-item <%= _isD3Active ? 'is-active' : '' %>">
                      <!-- prettier-ignore -->
                      <a
                        href="<%- getHrefByCode(_d3) %>"
                        class="gnb-category-link"
                        tabindex="<%= _isD3BoxActive ? '0' : '-1' %>"
                      >
                        <%- getName(d3) %>
                      </a>
                    </li>
                  <% }); %>
                </ul>
              </div>
            <% }); }); %>
          </div>

          <!-- 추천(항상 오른쪽, 영역 고정) -->
          <div class="gnb-category-col gnb-category-col-4">
            <div class="gnb-reco">
              <div class="gnb-reco-title">
                <span class="gnb-reco-title-point">요즘 잘 팔리는</span>
                <span class="gnb-reco-title-text">이 제품 어떠세요?</span>
              </div>
              <ul class="gnb-reco-list">
                <li class="gnb-reco-item"><a href="#!" class="gnb-reco-link">상품1</a></li>
                <li class="gnb-reco-item"><a href="#!" class="gnb-reco-link">상품2</a></li>
                <li class="gnb-reco-item"><a href="#!" class="gnb-reco-link">상품3</a></li>
              </ul>
            </div>
          </div>
        </div>
        <!-- /.gnb-category -->
      </div>
    </div>
  </div>
</div>
