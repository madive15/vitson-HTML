<% const _src = srcPath; const _public = publicPath; %>
<!-- prettier-ignore -->
<% const _base = srcPath.includes('vitson-HTML') ? '/vitson-HTML' : ''; %>
<!DOCTYPE html>
<html lang="ko" class="vm-scope">
  <%- include(`${_src}/views/layout-mo/header/head.ejs`, {meta_title: '거래약정서'}) %>
  <body class="vm-scope">
    <!-- S: Skip Navigation -->
    <a href="#skipNav" class="skip-nav">본문 바로가기</a>
    <!-- E: Skip Navigation -->

    <!-- S: vm-wrapper -->
    <section class="vm-wrapper">
      <!-- S: vm-wrap -->
      <div class="vm-wrap wrap-my-credit">
        <!-- S: vm-content-wrap -->
        <div class="vm-content-wrap">
          <!-- prettier-ignore -->
          <%- include(`${_src}/views/layout-mo/header/index.ejs`, { 
            type: 'nav-bar', 
            title: '검색'
          }) %>

          <!-- S: vm-main -->
          <main id="skipNav" class="vm-main">
            <div class="vm-main-content main-content-my-credit">
              <button
                type="button"
                class="vits-btn-md vits-btn-outline-secondary"
                onclick="VmKendoWindow.open('modal')"
              >
                <span class="text">거래약정서 팝업</span>
              </button>
            </div>
          </main>
          <!-- E: vm-main -->

          <%- include(`${_src}/views/layout-mo/footer/index.ejs`) %>
        </div>
        <!-- E: vm-content-wrap -->

        <!-- S: vm-bottom-group -->
        <!-- prettier-ignore -->
        <%- include(`${_src}/views/layout-mo/bottom-bar/index.ejs`, { 
          type: 'tab-bar', currentTab: 'mypage' 
        }) %>
        <!-- E: vm-bottom-group -->

        <!-- S: 팝업 영역 -->
        <!-- prettier-ignore -->
        <% const modal = { 
          id: 'modal', 
          title: '거래약정서', 
          className: 'modal-contract',
          contentPath: `${_src}/views/pages-mo/kendo-window/mypage/kw-MO_MY_05040602_M.ejs`,
          buttons: [
            { text: '취소', variant: 'secondary', action: 'close' },
            { text: '서명하기', variant: 'primary', action: 'close' }
          ]
        }; %>
        <%- include(`${_src}/views/components-mo/kendo/kendo-window.ejs`, modal) %>
        <!-- E: 팝업 영역 -->
      </div>
      <!-- E: vm-wrap -->
    </section>
    <!-- E: vm-wrapper -->

    <%- include(`${_src}/views/layout/footer.links.ejs`) %>

    <!-- S: [REMOVE] 확인용 script - type=signed 시 모달 자동 오픈 + 서명 완료 UI, 개발 적용 시 제거 -->
    <script>
      (function () {
        if (new URLSearchParams(location.search).get('type') !== 'signed') return;
        function run() {
          var c = document.querySelector('.vm-credit-contract');
          if (c) {
            // 날짜 input → span
            var dates = ['26', '5', '25', '27', '5', '26'];
            [].slice.call(c.querySelectorAll('.contract-date-row input.contract-input')).forEach(function (inp, i) {
              var s = document.createElement('span');
              s.className = 'signed-date';
              s.textContent = dates[i] || inp.getAttribute('data-signed-value') || '';
              inp.parentNode.replaceChild(s, inp);
            });

            // input → span
            c.querySelectorAll('.contract-info-cols input.contract-input').forEach(function (inp) {
              var s = document.createElement('span');
              s.className = 'contract-info-value';
              s.textContent = inp.getAttribute('data-signed-value') || inp.value || inp.placeholder || '';
              inp.parentNode.replaceChild(s, inp);
            });

            // vits-textarea 컴포넌트 → span
            c.querySelectorAll('.contract-info-cols .vits-textarea').forEach(function (wrap) {
              var ta = wrap.querySelector('textarea');
              var s = document.createElement('span');
              s.className = 'contract-info-value';
              s.textContent = (ta && (ta.getAttribute('data-signed-value') || ta.value || ta.placeholder)) || '';
              wrap.parentNode.replaceChild(s, wrap);
            });

            // 서명 이미지 — 공급받는자, 보증인 (signed일 때만)
            var signImgPath = '<%= _base %>/public/resources/img/mro/renewal/sign/temp-sign.png';
            c.querySelectorAll('.contract-sign-area[data-sign-role]').forEach(function (area) {
              var role = area.getAttribute('data-sign-role');
              if (role === 'recipient' || role === 'guarantor') {
                var img = document.createElement('img');
                img.src = signImgPath;
                img.alt = '서명';
                img.className = 'contract-sign-img';
                area.insertBefore(img, area.firstChild);
              }
            });
          }

          // kendo-window footer 버튼 → 저장하기로 교체
          var $footer = document.querySelector('#modal .vm-modal-footer .vm-modal-buttons');
          if ($footer) {
            $footer.className = 'vm-modal-buttons is-single';
            $footer.innerHTML =
              '<button type="button" class="vm-modal-btn vm-modal-btn-primary"><span class="text">저장하기</span></button>';
          }

          if (typeof VmKendoWindow !== 'undefined' && VmKendoWindow.open) VmKendoWindow.open('modal');
        }
        document.readyState === 'loading' ? document.addEventListener('DOMContentLoaded', run) : run();
      })();
    </script>
    <!-- E: [REMOVE] 확인용 script - 개발 적용 시 제거 -->
  </body>
</html>
