<% const _src = srcPath; const _public = publicPath; %>
<!-- prettier-ignore -->
<%
  // 퍼블 확인용 mock 데이터
  const mockData = require(`${_src}/../public/resources/mock/products.json`);
  const categoryTree = require(`${_src}/../public/resources/mock/category.json`);

  const _all = mockData.products.slice();
  for (let i = _all.length - 1; i > 0; i--) {
    const j = Math.floor(Math.random() * (i + 1));
    [_all[i], _all[j]] = [_all[j], _all[i]];
  }
  const _products = _all.slice(0, 20);
  const _recommendProducts = _all.slice(20, 30);

  // 초기 카테고리 경로 (퍼블 확인용)
  const _categoryPath = {
    depth1Id: '074003',
    depth2Id: '0740030049',
    depth3Id: '07400300490534'
  };

  // 카테고리 이름을 트리에서 추출
  const _d1 = categoryTree.tree.find(n => n.categoryCode === _categoryPath.depth1Id);
  const _d2 = _d1 && _d1.categoryList && _d1.categoryList.find(n => n.categoryCode === _categoryPath.depth2Id);
  const _d3 = _d2 && _d2.categoryList && _d2.categoryList.find(n => n.categoryCode === _categoryPath.depth3Id);
  const _categoryNames = [_d1, _d2, _d3].filter(Boolean).map(n => n.categoryNm);
  
  // 현재 카테고리 마지막 뎁스 이름
  const _currentCategoryNm = (_d3 && _d3.categoryNm) || (_d2 && _d2.categoryNm) || (_d1 && _d1.categoryNm) || '';

  // 필터 데이터 (인라인 + 팝업 공용)
  const _filterCommon = [
    { text: '오늘출발', value: 'today' },
    { text: '내일출발', value: 'tomorrow' },
    { text: '특가', value: 'sale' }
  ];

  const _filterCategory = [
    { text: 'LED램프', value: 'led' },
    { text: '용접봉', value: 'welding-rod' },
    { text: '절단석', value: 'cutting-disc' },
    { text: '안전용품', value: 'safety' },
    { text: '공구', value: 'tools' }
  ];

  const _filterAttr = [
    { text: '일자', value: 'flat', qty: 3 },
    { text: '십자', value: 'cross', qty: 4 }
  ];

  const _filterBrand = [
    { text: 'CRETOS', value: 'cretos', qty: 15 },
    { text: 'GEMINI', value: 'gemini', qty: 1 },
    { text: '고려용접봉', value: 'koryo', qty: 11 },
    { text: '고베', value: 'kobe', qty: 3 },
    { text: '니치아', value: 'nichia', qty: 20 },
    { text: '메서', value: 'messer', qty: 6 },
    { text: '세아', value: 'sea', qty: 8 },
    { text: '알루텍', value: 'alutek', qty: 2 },
    { text: '에어텍', value: 'airtek', qty: 5 },
    { text: '연합', value: 'yeonhap', qty: 3 },
    { text: '엘카', value: 'elka', qty: 7 },
    { text: '코스텍', value: 'kostek', qty: 4 },
    { text: '테크노', value: 'techno', qty: 1 },
    { text: '하이텍', value: 'hitek', qty: 2 },
    { text: '한국', value: 'hankook', qty: 9 },
    { text: '한양', value: 'hanyang', qty: 6 },
    { text: '현대', value: 'hyundai', qty: 12 },
    { text: '효성', value: 'hyosung', qty: 3 }
  ];
%>

<!DOCTYPE html>
<html lang="ko" class="vm-scope">
  <%- include(`${_src}/views/layout-mo/header/head.ejs`, {meta_title: '카테고리 상품목록'}) %>
  <body class="vm-scope">
    <!-- S: Skip Navigation -->
    <a href="#skipNav" class="skip-nav">본문 바로가기</a>
    <!-- E: Skip Navigation -->

    <!-- S: vm-wrapper -->
    <section class="vm-wrapper">
      <!-- S: vm-wrap -->
      <div class="vm-wrap wrap-category">
        <!-- S: vm-content-wrap -->
        <div class="vm-content-wrap">
          <!-- prettier-ignore -->
          <%- include(`${_src}/views/layout-mo/header/index.ejs`, { 
            type: 'nav-bar', title: _currentCategoryNm 
          }) %>

          <!-- S: vm-main -->
          <main id="skipNav" class="vm-main">
            <!-- prettier-ignore -->
            <%- include(`${_src}/views/components-mo/breadcrumb/index.ejs`, { 
              type: 'list',
              items: _categoryNames
            }) %>

            <div class="vm-main-content main-content-category">
              <!-- prettier-ignore -->
              <%- include(`${_src}/views/components-mo/filter/index.ejs`, { 
                type: 'product',
                items: [
                  { label: '브랜드', name: 'ck-brand', filters: _filterBrand },
                  { label: '공통', name: 'ck-common', filters: _filterCommon },
                  { label: '속성', name: 'ck-attr', filters: _filterAttr }
                ]
              }) %>

              <!-- prettier-ignore -->
              <%- include(`${_src}/views/components-mo/product/index.ejs`, {
                products: _products,
                recommendProducts: _recommendProducts
              }) %>
            </div>
          </main>
          <!-- E: vm-main -->
        </div>
        <!-- E: vm-content-wrap -->

        <!-- S: vm-bottom-group -->
        <!-- prettier-ignore -->
        <%- include(`${_src}/views/layout-mo/bottom-bar/index.ejs`, { 
          type: 'tab-bar', currentTab: 'category' 
        }) %>
        <!-- E: vm-bottom-group -->

        <!-- S: 팝업 영역 -->
        <!-- prettier-ignore -->
        <%- include(`${_src}/views/components-mo/kendo/kendo-window.ejs`, {
          id: 'categorySheet',
          title: '카테고리',
          variant: 'bottomsheet',
          className: 'modal-category-sheet',
          contentPath: `${_src}/views/pages-mo/kendo-window/category/kw-MO_CA_01020101.ejs`,
          contentData: {
            _src: _src,
            treeUrl: '/public/resources/mock/category.json',
            categoryPath: _categoryPath
          }
        }) %>

        <!-- prettier-ignore -->
        <%- include(`${_src}/views/components-mo/kendo/kendo-window.ejs`, {
          id: 'filterSheet',
          title: '필터',
          variant: 'slide-right',
          className: 'modal-filter-sheet',
          contentPath: `${_src}/views/pages-mo/kendo-window/category/kw-MO_CA_01020101-filter.ejs`,
          contentData: {
            _src: _src,
            filterItems: [
              { label: '공통', name: 'ck-common', filters: _filterCommon },
              { label: '카테고리', name: 'ck-category', filters: _filterCategory },
              { label: '속성', name: 'ck-attr', filters: _filterAttr },
              { label: '브랜드', name: 'ck-brand', filters: _filterBrand }
            ]
          },
          buttons: [
            { text: '닫기', variant: 'secondary', action: 'close' },
            { text: '적용하기', variant: 'primary', attrs: { 'data-filter-apply': '' } }
          ]
        }) %>
        <!-- E: 팝업 영역 -->
      </div>
      <!-- E: vm-wrap -->
    </section>
    <!-- E: vm-wrapper -->

    <%- include(`${_src}/views/layout/footer.links.ejs`) %>

    <div
      data-category-sheet
      data-tree-url="/public/resources/mock/category.json"
      data-depth1="<%= _categoryPath.depth1Id %>"
      data-depth2="<%= _categoryPath.depth2Id %>"
      data-depth3="<%= _categoryPath.depth3Id %>"
      style="display: none"
    ></div>
  </body>
</html>
