// -----------------------------------------------------------------------------
// layout/_header.scss
// - 헤더 내부 UI 전용. 레이아웃(높이/배치)은 layout/_wrapper.scss에서만 제어.
// -----------------------------------------------------------------------------

@use 'sass:map';
@use '@/assets/scss/abstracts/variables' as var;
@use '@/assets/scss/abstracts/mixins' as mx;
@use '@/assets/scss/abstracts/functions' as fn;
@use '@/assets/scss/base/colors' as color;
@use '@/assets/scss/base/typography' as typo;
@use '@/assets/scss/components/icon' as icon;
@use '@/assets/scss/components/button' as button;

$header-rank-height: fn.rem(24);
$header-rank-bar-height: fn.rem(18);
$header-search-width: fn.rem(380);
$header-search-panel-right: fn.rem(200);
$header-gnb-more-height: fn.rem(28);

@mixin gnb-btn-active-style {
  .icon {
    color: map.get(color.$brand-colors, 'primary');
  }

  .text {
    color: map.get(color.$brand-colors, 'primary');
  }
}

@mixin header-common-relative($type: null) {
  position: relative;

  @if $type != 'main' {
    z-index: var.$zindex-base;
  }
  // stylelint-disable-next-line at-rule-empty-line-before
  @else {
    z-index: var.$zindex-base + 1;
  }
  background: color.$color-white;
}

@mixin gnb-category-link {
  background: map.get(color.$layout-status, 'info-bg-sub');

  .text {
    font-weight: 700;
    color: map.get(color.$text-status, 'info-sub');
  }

  &:has(> .icon) {
    padding-right: map.get(var.$unit, 24);
  }
}

.vits-header {
  @include mx.border($color: map.get(color.$layout-border, 'quaternary'));
  position: relative;
  z-index: var.$zindex-base + 1;
  background: color.$color-white;

  &-topbar {
    @include header-common-relative;
    @include mx.flex(flex, row, flex-start, center);
    @include mx.border($color: map.get(color.$gray-shades, '30'));
    height: var.$header-topbar-height;

    .vits-inner {
      @include mx.flex(flex, row, space-between, center);
    }

    .header-topbar {
      &-right {
        @include mx.divider($h: 8);

        &-spacer {
          a + a {
            margin-left: map.get(var.$unit, 24);
          }
        }
      }
    }
  }

  &-main {
    @include header-common-relative('main');
    @include mx.flex(flex, row, flex-start, center);
    height: var.$header-main-height;

    .vits-inner {
      @include mx.flex(flex, row, space-between, center);
    }

    .header-main {
      &-logo {
        display: block;
        width: fn.rem(144);
      }

      &-search {
        @include mx.flex(flex, row, center, center);
        gap: map.get(var.$unit, 20);

        /* 실시간 검색어 */
        &-rank {
          position: relative;
          width: fn.rem(140);

          .header-rank {
            &-bar {
              @include mx.flex(flex, row, flex-start, center);
              gap: map.get(var.$unit, 8);
              height: $header-rank-bar-height;
            }

            &-link {
              @include mx.flex(inline-flex, row, flex-start, center);
              min-width: 0;
              margin-right: auto;
            }

            /* 2줄을 쌓아두는 트랙(여기만 움직임) */
            &-track {
              display: block;
              transition: transform 0.6s ease; /* JS data-rank-duration과 맞추기 */
              transform: translateY(0);
              will-change: transform;
            }

            /* 롤링 뷰(마스킹) */
            &-view {
              display: block;
              width: 100%;
              height: $header-rank-height;
              overflow: hidden;

              /* 롤링 상태: 트랙을 한 줄만큼 올림 */
              &.is-rolling .header-rank-track {
                transform: translateY(-#{$header-rank-height});
              }
            }

            /* 한 줄(현재/다음) */
            &-row {
              @include mx.flex(flex, row, flex-start, center);
              gap: map.get(var.$unit, 8);
              height: $header-rank-height;
              line-height: $header-rank-height;
            }

            &-num {
              @include typo.typography('b3sb', $color: map.get(color.$brand-colors, 'primary'));
            }

            &-word {
              @include typo.typography('b3r', $color: map.get(color.$text-colors, 'default'));
              @include mx.ellipsis-single;
            }

            &-move {
              &::before {
                @include typo.typography('b3r', $color: map.get(color.$text-colors, 'default'));
                display: block;
              }

              &.rank-move-up::before {
                color: map.get(color.$brand-colors, 'primary');
                content: '\2191';
              }

              &.rank-move-down::before {
                color: map.get(color.$blue-shades, '100');
                content: '\2193';
              }

              &.rank-move-same::before {
                content: '-';
              }
            }

            /* 토글 버튼 */
            &-btn {
              @include button.btn-reset;
              @include icon.ic-size(fn.rem(16));
              box-sizing: content-box;
              flex-shrink: 0;
              padding: map.get(var.$unit, 4);
              margin: -#{map.get(var.$unit, 4)};
              color: map.get(color.$brand-colors, 'primary');
              transition: transform 0.4s;
            }

            /* 패널(toggle.js: is-open 사용) */
            &-panel {
              position: absolute;
              top: $header-rank-bar-height;
              left: 0;
              z-index: var.$zindex-header-rank;
              min-width: 260px;
              padding: 12px;
              background: #fff;
              border: 1px solid #dadada;
              border-radius: map.get(var.$radius, 'md');

              &-head {
                display: flex;
                gap: 12px;
                align-items: center;
                justify-content: space-between;
                margin-bottom: 8px;
              }

              &-close {
                padding: 0;
                cursor: pointer;
                background: transparent;
                border: 0;
              }

              &:not(.is-open) {
                max-height: 0;
              }
            }
          }

          &:has(.header-rank-panel.is-open) {
            .header-rank-btn {
              transform: rotate(180deg);
            }
          }
        }

        /* 통합 검색어창 */
        &-form {
          position: relative;

          .header-search {
            &-input {
              @include mx.flex(flex, row, space-between, center);
              @include mx.border('all', $width: 2px, $color: map.get(color.$layout-border, 'primary'));
              @include mx.input-search-reset;
              gap: map.get(var.$unit, 8);
              width: $header-search-width;
              height: fn.rem(40);
              padding: 0 map.get(var.$unit, 20);
              background: color.$color-white;
              border-radius: map.get(var.$radius, 'sm');
            }

            &-field {
              @include typo.typography('b3r');
              flex-grow: 1;
            }

            &-submit {
              @include button.btn-reset;
              @include icon.ic-size(map.get(var.$unit, 24));
              margin-right: -#{map.get(var.$unit, 2)};
            }

            &-panel {
              @include mx.position(absolute, 100%, $left: 0);
              @include mx.border('all');
              z-index: var.$zindex-header-search;
              width: $header-search-width;
              background: color.$color-white;

              .search-panel {
                &-left {
                  position: relative;
                  z-index: var.$zindex-base;
                  width: $header-search-width;
                }

                &-right {
                  @include mx.position(absolute, 0, 0);
                  width: $header-search-panel-right;
                  padding: 12px;
                  border-left: 1px solid #eee;
                }
              }

              &.is-open {
                &:has(.search-panel-right.is-active) {
                  width: $header-search-width + $header-search-panel-right;
                }
              }
            }
          }
        }
      }

      &-util {
        @include mx.flex;
        gap: map.get(var.$unit, 12);
      }
    }
  }

  &-gnb {
    @include header-common-relative;

    .gnb {
      &-bar {
        @include mx.flex(flex, row, flex-start, flex-start);
        gap: 0 map.get(var.$unit, 32);
      }

      &-link {
        @include mx.flex(flex, row, flex-start, center);
        @include typo.typography('b2s');
        flex-shrink: 0;
        height: var.$header-gnb-height;
        padding: 0 map.get(var.$unit, 24);
      }

      /* 오버플로우 판정 대상(홈+프로모션) */
      &-nav {
        @include mx.flex(flex, row, flex-start, flex-start);
        flex-grow: 1;
        min-width: 0;

        // max-width: max-content;
        max-height: var.$header-gnb-height;
        overflow: hidden;

        &-list {
          @include mx.flex(flex, row, flex-start, flex-start);
          position: relative;
          width: 100%;
          min-width: 0;

          // 더보기 버튼 노출 시, 마진값 변경
          &:has(.gnb-more-box.is-active) {
            .gnb-item-promo {
              margin-left: map.get(var.$unit, 32);
            }
          }
        }

        /* 펼침: 목록은 필요 시 다음 줄로 내려가도 됨(wrap), 각 링크 텍스트는 1줄(말줄임) */
        &.is-expanded {
          max-height: var.$header-gnb-full-height;
          overflow: hidden auto;

          .gnb-link {
            @include mx.ellipsis-single;
            display: inline-flex;
            max-width: 100%;

            &:has(.exhibition-item-sub) {
              flex-direction: column;
              align-items: flex-start;
              justify-content: center;

              .exhibition-item {
                &-sub {
                  @include typo.typography('h4s');
                  font-style: normal;
                }

                &-text {
                  @include typo.typography('b2r', $color: map.get(color.$text-colors, 'quaternary'));
                }
              }
            }
          }
        }
      }

      &-item {
        &:not(.gnb-item-promo-list) {
          flex: 0 0 auto;
        }

        &.gnb-item-home,
        &.gnb-item-deal {
          margin-right: map.get(var.$unit, 12);
        }

        &.gnb-item-promo {
          margin-left: map.get(var.$unit, 12);

          /* stylelint-disable-next-line no-descending-specificity */
          .gnb-link {
            padding-right: 0;
          }
        }

        // 기획전 페이지 나열
        &.gnb-item-promo-list {
          @include mx.flex(flex, row, flex-start, stretch);
          position: relative;
          flex: 0 1 auto;
          min-width: 0;

          .gnb-promo-list {
            @include mx.flex;
            flex: 0 1 auto;
            gap: map.get(var.$unit, 12);
            min-width: 0;
            max-width: fn.rem(710);
            overflow: hidden;

            .gnb-link.is-hidden {
              display: none;
            }
          }

          // 더보기 버튼 옆 세로선, 더보기 있을 때만 표시
          &:has(.gnb-more-box.is-active) {
            &::after {
              @include mx.position(absolute, calc((var.$header-gnb-height - $header-gnb-more-height) / 2), 0);
              z-index: var.$zindex-base;
              width: 1px;
              height: $header-gnb-more-height;
              pointer-events: none;
              content: '';
              background: map.get(color.$layout-border, 'quinary');
            }
          }
        }
      }

      /* 가획전, 이벤트 목록 */
      &-fixed-list {
        @include mx.flex;
        flex-shrink: 0;
        max-width: max-content;
      }

      &-left {
        @include mx.flex(flex, row, flex-start, center);
        flex-shrink: 0;
        gap: map.get(var.$unit, 32);
      }

      /* 전체카테고리, 브랜드 버튼 */
      &-btn {
        @include button.btn-reset;
        @include mx.flex(flex, row, center, center);
        gap: map.get(var.$unit, 4);
        height: var.$header-gnb-height;

        .icon {
          @include icon.ic-size(fn.rem(24));
          color: map.get(color.$icon-neutral, 'primary');
          transition: transform 0.3s;
          will-change: transform;
        }

        .text {
          @include typo.typography('h4s', $color: map.get(color.$neutral-colors, '1'));
        }

        &.category .icon.left {
          @include icon.ic-size(fn.rem(28));
        }

        &[aria-expanded='true'] {
          @include gnb-btn-active-style;

          .icon.right {
            transform: rotate(180deg);
          }
        }

        @include mx.common-mouse-event {
          @include gnb-btn-active-style;
        }
      }

      /* 더보기(+) */
      &-more {
        @include button.btn-reset;
        position: relative;
        z-index: var.$zindex-base + 2;
        margin-right: fn.rem(9);

        .icon {
          @include icon.ic-size($header-gnb-more-height);
          display: block;
          padding: map.get(var.$unit, 2);
          color: map.get(color.$icon-neutral, 'tertiary');
          transition: transform 0.3s;
          will-change: transform;
        }

        // 공통 “강조 상태” 스타일(aria-expanded/hover 공용)
        @mixin more-active-style {
          .icon {
            color: map.get(color.$brand-colors, 'primary');
            transform: rotate(45deg * 3);
          }
        }

        &[aria-expanded='true'] {
          @include more-active-style;
        }

        @include mx.common-mouse-event {
          @include more-active-style;
        }

        &-box {
          @include mx.position(absolute, calc((var.$header-gnb-height - fn.rem(28)) / 2), 0);
          z-index: var.$zindex-base;
          display: none;
          background: color.$color-white;

          // 그라데이션
          &::before {
            @include mx.position(absolute, 0, fn.rem(37)); // 버튼 + mr
            z-index: var.$zindex-base;
            width: fn.rem(116);
            height: 100%;
            pointer-events: none;
            content: '';
            background: linear-gradient(to right, rgb(255 255 255 / 0%), rgb(255 255 255 / 100%));
          }

          &::after {
            @include mx.position(absolute, 0, 9px);
            width: $header-gnb-more-height;
            height: $header-gnb-more-height;
            content: '';
            background: map.get(color.$layout-surf, 'base');
            border-radius: map.get(var.$radius, 'sm');
            box-shadow: inset 0 0 0 1px map.get(color.$layout-border, 'quaternary');
            transition: box-shadow 0.2s;
          }

          &:has(.gnb-more:hover),
          &:has(.gnb-more[aria-expanded='true']) {
            &::after {
              box-shadow: inset 0 0 0 1px map.get(color.$brand-colors, 'primary');
            }
          }

          &.is-active {
            display: flex;
          }
        }
      }

      &-panel {
        @include mx.position(absolute, 100%, $left: 0);
        @include mx.border('top', $color: map.get(color.$layout-border, 'quaternary'));
        @include mx.border;
        z-index: var.$zindex-header-panel;
        width: 100%;
        background: color.$color-white;

        &.is-open {
          max-height: var.$header-panel-height-max;
        }

        /* 기획전 리스트 */
        &.gnb-panel-more {
          position: static;
          border-bottom: 0;

          .gnb-panel {
            &-inner {
              background: map.get(color.$layout-surf, 'raised');
            }

            &-body {
              @include mx.flex(flex, column);
              max-height: 50vh;
              padding: 0 0 map.get(var.$unit, 36);
              overflow-y: auto;

              &-title {
                @include typo.typography('b2s', $color: map.get(color.$text-colors, 'secondary'));
                position: sticky;
                top: 0;
                z-index: var.$zindex-base;
                width: 100%;
                padding: map.get(var.$unit, 24) 0;
                background: linear-gradient(
                  180deg,
                  rgb(250 250 250 / 100%) 0%,
                  rgb(250 250 250 / 100%) 70%,
                  rgb(250 250 250 / 0%) 100%
                );
              }
            }

            &-list {
              display: grid;
              grid-template-columns: repeat(auto-fill, minmax(fn.rem(200), 1fr));
              gap: map.get(var.$unit, 16);

              &:not(:has(> li:nth-child(6))) {
                grid-template-columns: repeat(auto-fill, fn.rem(200));
              }
            }
          }

          &[data-toggle-box].is-open {
            overflow: hidden;
          }
        }
      }

      // 전체 카테고리 패널
      &-panel-category {
        &.is-open {
          max-height: 100vh;
          overflow: hidden;
        }

        .gnb-category {
          @include mx.flex(flex, row, flex-start, stretch);
          height: fn.rem(690);

          &-col {
            overflow: hidden auto;

            &:not(:last-of-type) {
              @include mx.border('right', $color: map.get(color.$layout-border, 'quaternary'));
            }
          }

          &-col:not(.gnb-category-col-4) {
            flex: 0 0 fn.rem(220);
          }

          &-link {
            @include mx.flex(flex, row, flex-start, center);
            position: relative;
            display: block;
            min-height: map.get(var.$unit, 40);
            padding: fn.rem(10) 0 fn.rem(10) map.get(var.$unit, 16);
            overflow: hidden;

            .text {
              @include typo.typography('b3r');
            }

            .icon {
              @include mx.position(absolute, 50%, fn.rem(6));
              @include icon.ic-size(fn.rem(18));
              flex-shrink: 0;
              color: map.get(color.$icon-status, 'info');
              opacity: 0;
              transition:
                transform 0.35s ease,
                opacity 0.25s ease;
              transform: translate(100%, -50%);
            }

            @include mx.common-mouse-event {
              @include gnb-category-link;
            }
          }

          // 전체카테고리 > 추천 상품
          .gnb-category-col-4 {
            flex: 1 1 auto;
            min-width: 0;
            padding-left: fn.rem(58);
          }

          .gnb-reco {
            @include mx.flex(flex, column);
            gap: map.get(var.$unit, 20);
            padding: map.get(var.$unit, 32) 0;

            &-title {
              &-point {
                @include typo.typography('b2b', $color: map.get(color.$text-status, 'brand'));
              }

              &-text {
                @include typo.typography('b2b', $color: map.get(color.$text-status, 'secondary'));
              }
            }

            &-list {
              @include mx.flex(flex, row, flex-start, stretch);
              gap: map.get(var.$unit, 20);
            }

            &-item {
              flex-shrink: 0;
              width: fn.rem(168);
            }
          }

          // 현재 포커스(마우스 기준) 표시
          &-item.is-current > .gnb-category-link {
            @include gnb-category-link;
          }

          // view - none
          .gnb-category-col-2,
          .gnb-category-col-2 .gnb-category-box,
          .gnb-category-col-3,
          .gnb-category-col-3 .gnb-category-box,
          .gnb-category-col-3 .gnb-category-box:not(:has(.gnb-category-list-3 li)) {
            // 3뎁스 박스는 하위(li)가 없으면 아예 숨김(영역 차지 방지)
            display: none;
          }

          .gnb-category-col-2 .gnb-category-box.is-active,
          .gnb-category-col-3 .gnb-category-box.is-active,
          &.is-col2-open .gnb-category-col-2,
          &.is-col3-open .gnb-category-col-3 {
            display: block;
          }

          // 하위 메뉴 있으면 화살표 아이콘 노출
          &.is-col2-open .gnb-category-col-1 .gnb-category-item.is-active .gnb-category-link,
          &.is-col3-open .gnb-category-col-2 .gnb-category-item.is-active .gnb-category-link {
            padding-right: map.get(var.$unit, 24);

            .icon {
              opacity: 1;
              transform: translate(0, -50%);
            }
          }
        }
      }
    }

    &.is-more-visible {
      .gnb-more-box {
        display: block;
      }
    }
  }

  .gnb-dim {
    @include mx.position(fixed, 0, 0, 0, 0);
    z-index: var.$zindex-base;
    display: none;
    background: color.$color-dim;

    &[aria-hidden='false'] {
      display: block;
    }
  }
}

/* HEADER GNB 추천 상품 아이템 */
.gnb-reco-item {
  // 회원 시, 비노출
  &[data-member='true'] {
    .product-price-alt.is-guest {
      display: none !important;
    }
  }

  // 비회원 시, 비노출
  &[data-member='false'] {
    .product-extra,
    .vits-price-box.is-normal,
    .product-price-alt.is-soldout,
    .product-actions {
      display: none !important;
    }
  }

  // 판매중, 비노출
  &[data-stock='true'] {
    .product-price-alt.is-soldout {
      display: none !important;
    }
  }

  // 일시품절, 비노출
  &[data-stock='false'] {
    .vits-price-box.is-normal {
      display: none !important;
    }
  }

  // 상품 아이템
  &-card {
    @include mx.flex(flex, column, flex-start, flex-start);
    gap: map.get(var.$unit, 8);

    .product {
      &-thumb {
        @include mx.common-list-thumb;
      }

      &-body {
        @include mx.flex(flex, column);
        gap: map.get(var.$unit, 8);
        width: 100%;
      }

      &-name {
        @include typo.typography('b3s', $color: map.get(color.$text-colors, 'primary'));
        @include mx.ellipsis-multi(1.3, 2);
      }

      &-price {
        .price-origin-label {
          @include typo.typography('d3r', $color: map.get(color.$text-colors, 'tertiary'));
          text-decoration: line-through;
          text-decoration-line: line-through;
        }

        .price-sale-row {
          @include mx.flex(flex, row, flex-start, center);
          gap: map.get(var.$unit, 4);

          .price-rate {
            @include typo.typography('b1b', $color: map.get(color.$text-status, 'brand'));
          }

          .price-sale {
            @include typo.typography('b1b', $color: map.get(color.$text-colors, 'primary'));
          }
        }

        .product-price-alt.is-soldout {
          @include typo.typography('b1b', $color: map.get(color.$label-shipping, 'today'));
        }

        .product-price-alt.is-guest {
          @include mx.flex(flex, column, flex-start, flex-start);
          gap: map.get(var.$unit, 12);

          .price-guest-text {
            @include mx.flex(flex, column, flex-start, flex-start);
            gap: map.get(var.$unit, 2);

            &-title {
              @include typo.typography('b4s', $color: map.get(color.$text-status, 'info-sub'));
            }

            &-desc {
              @include typo.typography('b4r', $color: map.get(color.$text-colors, 'secondary'));
            }
          }

          .price-guest-action {
            width: 100%;

            .price-login-button {
              @include button.btn-reset;
              @include mx.flex(flex, row, center, center);
              @include mx.border('all', $color: map.get(color.$layout-border, 'tertiary'));
              gap: fn.rem(10);
              width: 100%;
              height: map.get(var.$unit, 32);
              padding: 0 map.get(var.$unit, 8);
              border-radius: map.get(var.$radius, 'sm');

              .icon {
                @include icon.ic-size(map.get(var.$unit, 16));
                color: map.get(color.$icon-neutral, 'primary');
              }

              .text {
                @include typo.typography('b3r', $color: map.get(color.$text-colors, 'tertiary'));
              }
            }
          }
        }
      }
    }
  }
}

// 디자인 나오면 수정하기
// == 실시간 검색어 ==
/* 리스트 */
.header-rank-list {
  padding: 0;
  margin: 0;
  list-style: none;
}

.header-rank-item + .header-rank-item {
  margin-top: 6px;
}

.header-rank-item-link {
  display: inline-flex;
  gap: 8px;
  align-items: center;
  color: inherit;
  text-decoration: none;
}

// == 통합 검색어 ==
/* 패널 내부 3칸: 좌(고정) + 가운데(여백) + 우(고정) */
.search-panel-wrap {
  display: flex;
  align-items: stretch;
}

/* 우측 상품목록: 기본 숨김, 활성화 시만 표시(맨 오른쪽 끝에 붙음) */
/* 최근 검색어 */
.search-recent {
  padding: 12px;

  .search-head {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: 8px;
  }

  .search-keyword-list {
    display: flex;
    flex-wrap: wrap;
    gap: 6px;

    li {
      display: flex;
      gap: 4px;
      align-items: center;
      padding: 4px 8px;
      border: 1px solid #eee;
      border-radius: map.get(var.$radius, 'lg');
    }
  }
}

/* 연관 검색어 */
.search-related {
  padding: 12px;
  border-top: 1px solid #eee;

  .search-title {
    display: block;
    margin-bottom: 8px;
  }
}

.search-related-item {
  padding: 10px 8px;
  cursor: pointer;

  &:hover {
    background: #f6f6f6;
  }
}

.search-related-label {
  display: block;
  font-size: 12px;
  line-height: 1.3;
  color: #888;
  word-break: break-word;
}

.search-related-label em {
  font-style: normal;
  color: #ff6a00;
}

.search-related-text {
  display: block;
  margin-top: 4px;
  font-size: 14px;
  line-height: 1.4;
  color: #222;

  &:empty {
    display: none;
  }

  em {
    font-style: normal;
    color: #ff6a00;
  }
}

/* 우측 상품목록 패널(내용 전환) */
.related-products-panel {
  display: none;
}

.related-products-panel.is-active {
  display: block;
}

/* 더미 상품 카드 */
.related-products-grid {
  display: grid;
  grid-template-columns: repeat(3, 1fr);
  gap: 10px;
}

.product-card a {
  display: block;
  color: inherit;
  text-decoration: none;
}

.product-card .thumb {
  display: block;
  width: 100%;
  padding-top: 100%;
  background: #f2f2f2;
  border-radius: map.get(var.$radius, 'md');
}

.product-card .name {
  display: block;
  margin-top: 6px;
  font-size: 13px;
  line-height: 1.3;
}
